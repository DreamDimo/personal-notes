## å¹¶å‘ç¼–ç¨‹

### ä¸€ã€è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹

#### 1. çº¿ç¨‹çŠ¶æ€

```java
public static enum State {
    NEW,
    RUNNABLE,
    BLOCKED,
    WAITING,
    TIMED_WAITING,
    TERMINATED;
}
```

#### 2. åç¨‹

##### 2.1 å®šä¹‰

**åç¨‹ï¼ˆCoroutineï¼‰** æ˜¯ä¸€ç§æ¯”çº¿ç¨‹æ›´è½»é‡çº§çš„å¹¶å‘å•ä½ã€‚
 ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯â€œ**å¯æŒ‚èµ·ï¼ˆsuspendï¼‰å’Œæ¢å¤ï¼ˆresumeï¼‰çš„å‡½æ•°**â€ï¼Œå…è®¸ä½ åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æš‚åœã€åˆ‡æ¢åˆ°åˆ«çš„ä»»åŠ¡ï¼Œå†å›æ¥ç»§ç»­æ‰§è¡Œã€‚

##### 2.2 ç‰¹ç‚¹

åç¨‹æ˜¯ä¸€ç§**ç”¨æˆ·æ€çš„å¹¶å‘æœºåˆ¶**ï¼Œä¸éœ€è¦æ“ä½œç³»ç»Ÿä»‹å…¥åˆ‡æ¢ï¼Œä»è€Œå®ç°é«˜æ•ˆçš„å¼‚æ­¥æ‰§è¡Œã€‚

ä¼ ç»Ÿå¹¶å‘æ–¹å¼ï¼š

- **å¤šçº¿ç¨‹**ï¼šå¼€é”€å¤§ã€è°ƒåº¦ç”±å†…æ ¸æ§åˆ¶ã€é¢‘ç¹åˆ‡æ¢æµªè´¹æ€§èƒ½ï¼›
- **å›è°ƒï¼ˆcallbackï¼‰**ï¼šä»£ç ç»“æ„æ··ä¹±ã€éš¾ä»¥ç»´æŠ¤ï¼ˆâ€œå›è°ƒåœ°ç‹±â€ï¼‰ã€‚

åç¨‹çš„ä¼˜åŠ¿ï¼š

- ä¸éœ€è¦å¤šçº¿ç¨‹ï¼Œä¹Ÿèƒ½å®ç°é«˜å¹¶å‘ï¼›
- ä»£ç ç»“æ„çœ‹èµ·æ¥æ˜¯â€œåŒæ­¥â€çš„ï¼Œä½†åº•å±‚æ˜¯å¼‚æ­¥æ‰§è¡Œï¼›
- é¿å…é”ç«äº‰ï¼Œä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

##### 2.3 åŸç†

**ä¿å­˜å½“å‰å‡½æ•°çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆæ ˆå¸§ï¼‰**ï¼Œå¹¶åœ¨ç¨åæ¢å¤å®ƒã€‚

äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰ï¼šè´Ÿè´£è°ƒåº¦å’Œç®¡ç†åç¨‹çš„è¿è¡Œï¼Œæ˜¯æ•´ä¸ªåç¨‹ç³»ç»Ÿçš„â€œå¿ƒè„â€ã€‚

åç¨‹è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰ï¼šå†³å®šå“ªä¸ªåç¨‹å¯ä»¥æ‰§è¡Œã€å“ªä¸ªè¦ç­‰å¾…ï¼ˆä¾‹å¦‚ç­‰å¾… I/Oï¼‰ã€‚

æŒ‚èµ·ä¸æ¢å¤ï¼ˆSuspend/Resumeï¼‰ï¼šå½“åç¨‹é‡åˆ° I/O æ“ä½œæ—¶ï¼Œå®ƒä¼šä¸»åŠ¨æŒ‚èµ·ï¼ˆyieldï¼‰ï¼Œè®©å‡ºæ‰§è¡Œæƒï¼›å½“ I/O å®Œæˆåï¼Œè°ƒåº¦å™¨å†æ¢å¤è¯¥åç¨‹çš„æ‰§è¡Œ

##### 2.4 å®è·µ

æ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½è¦åŠ  `await`ï¼›ç”¨ `asyncio.gather()` æ¥å¹¶å‘è¿è¡Œå¤šä¸ªä»»åŠ¡ï¼›é¿å…åœ¨åç¨‹ä¸­ä½¿ç”¨é˜»å¡å‡½æ•°ï¼ˆå¦‚ `time.sleep()`ï¼‰ï¼›ç½‘ç»œã€I/O æ“ä½œè¦ç”¨å¼‚æ­¥åº“ï¼ˆå¦‚ `aiohttp`ã€`aiomysql`ï¼‰ï¼›ç”¨ `asyncio.run()` å¯åŠ¨ä¸»äº‹ä»¶å¾ªç¯ã€‚

ä¸‹é¢çš„ä¾‹å­ä¸­æ˜¯å¯åŠ¨å¾ªç¯ï¼Œç„¶ååŒæ—¶è®¿é—®ä¸‰ä¸ªç½‘ç«™ï¼Œ`run` æ˜¯å¯åŠ¨äº‹ä»¶å¾ªç¯ï¼Œ`await` æ˜¯é˜»å¡äº‹ä»¶è°ƒç”¨ï¼Œè¡¨ç¤ºæ‰§è¡Œå®Œè·å¾—ç»“æœåæ‰ç»§ç»­ï¼Œæ‰€ä»¥çœŸæ­£èµ·åˆ°å¹¶å‘ä½œç”¨çš„æ˜¯ `gather`

```python
import asyncio
import aiohttp  # å¼‚æ­¥ HTTP åº“

async def fetch(url):
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as resp:
            print(f"è·å– {url} çŠ¶æ€ç : {resp.status}")
            return await resp.text()

async def main():
    urls = [
        "https://www.python.org",
        "https://docs.python.org/3/",
        "https://www.github.com"
    ]
    results = await asyncio.gather(*(fetch(url) for url in urls))
    print("å·²è·å–ç½‘é¡µæ•°é‡ï¼š", len(results))

asyncio.run(main())
```

##### 2.5 workeråç¨‹

**Worker åç¨‹**å¯ä»¥ç†è§£ä¸ºï¼š

> â€œä¸€ä¸ªæŒç»­è¿è¡Œã€ä¸æ–­ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶å¼‚æ­¥æ‰§è¡Œçš„åç¨‹å·¥ä½œè€…ã€‚â€

æ¢å¥è¯è¯´ï¼š

- ä¸»çº¿ç¨‹æˆ–ä¸Šæ¸¸é€»è¾‘è´Ÿè´£ **ç”Ÿäº§ä»»åŠ¡ï¼ˆProducerï¼‰**ï¼›
- è‹¥å¹²ä¸ª **Worker åç¨‹** è´Ÿè´£ **æ¶ˆè´¹ä»»åŠ¡ï¼ˆConsumerï¼‰**ï¼›
- ä¸¤è€…ä¹‹é—´é€šè¿‡ä¸€ä¸ª **å¼‚æ­¥é˜Ÿåˆ—ï¼ˆasyncio.Queueï¼‰** é€šä¿¡ã€‚

è¿™ç§æ¨¡å¼ä¹Ÿç§°ä¸º **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼ˆProducer-Consumer Patternï¼‰** çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚

```python
import asyncio
import random

async def worker(name, queue):
    while True:
        task = await queue.get()  # ä»é˜Ÿåˆ—å–ä»»åŠ¡ï¼ˆé˜»å¡ç­‰å¾…ï¼‰
        if task is None:  # é€€å‡ºä¿¡å·
            print(f"ğŸ§¹ {name} åœæ­¢å·¥ä½œ")
            break
        print(f"âš™ï¸ {name} å¼€å§‹æ‰§è¡Œä»»åŠ¡ {task}")
        await asyncio.sleep(random.uniform(0.5, 2.0))  # æ¨¡æ‹ŸI/Oæ“ä½œ
        print(f"âœ… {name} å®Œæˆä»»åŠ¡ {task}")
        queue.task_done()  # æ ‡è®°ä»»åŠ¡å®Œæˆ

async def main():
    queue = asyncio.Queue()

    # åˆ›å»ºå¤šä¸ª worker åç¨‹
    workers = [asyncio.create_task(worker(f"Worker-{i}", queue)) for i in range(3)]

    # æ¨¡æ‹Ÿç”Ÿäº§ä»»åŠ¡
    for i in range(10):
        await queue.put(i)
        print(f"ğŸ“¦ æ”¾å…¥ä»»åŠ¡ {i}")

    # ç­‰å¾…ä»»åŠ¡å…¨éƒ¨å®Œæˆ
    await queue.join()

    # é€šçŸ¥æ‰€æœ‰ worker é€€å‡º
    for _ in workers:
        await queue.put(None)

    # ç­‰å¾…æ‰€æœ‰ worker åç¨‹é€€å‡º
    await asyncio.gather(*workers)

asyncio.run(main())
```

#### 3. é˜»å¡

##### 3.1 æ™®é€šå¤šçº¿ç¨‹ç¨‹åº

```python
import threading
import time

def task(name):
    print(f"{name} å¼€å§‹")
    time.sleep(3)  # é˜»å¡å½“å‰çº¿ç¨‹
    print(f"{name} ç»“æŸ")

t1 = threading.Thread(target=task, args=("ä»»åŠ¡1",))
t2 = threading.Thread(target=task, args=("ä»»åŠ¡2",))

t1.start()
t2.start()
```

ğŸ” è¯´æ˜ï¼š

- `time.sleep(3)` é˜»å¡çš„æ˜¯**è¯¥çº¿ç¨‹è‡ªå·±**ï¼›
- ä½†å…¶ä»–çº¿ç¨‹ï¼ˆå¦‚ `t2`ï¼‰ä»ç„¶å¯ä»¥è¿è¡Œï¼›
- æ‰€ä»¥æ•´ä¸ªç¨‹åº**å¹¶ä¸ä¼šå¡ä½**ã€‚

âœ… **ç»“è®º**ï¼š

> åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹é˜»å¡ï¼Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„æ‰§è¡Œã€‚

##### 3.2 å¼‚æ­¥åç¨‹

```python
import asyncio
import time

async def bad_task():
    print("å¼€å§‹")
    time.sleep(3)  # âŒ è¿™æ˜¯é˜»å¡æ“ä½œ
    print("ç»“æŸ")

async def good_task():
    print("å¼€å§‹å¼‚æ­¥ç­‰å¾…")
    await asyncio.sleep(3)  # âœ… éé˜»å¡
    print("ç»“æŸå¼‚æ­¥ç­‰å¾…")

async def main():
    await asyncio.gather(bad_task(), good_task())

asyncio.run(main())
```

âš ï¸ è¾“å‡ºç»“æœï¼š

```
å¼€å§‹
ï¼ˆæ•´ä¸ªç¨‹åºå¡ä½3ç§’ï¼‰
ç»“æŸ
å¼€å§‹å¼‚æ­¥ç­‰å¾…
ç»“æŸå¼‚æ­¥ç­‰å¾…
```

ğŸ” åŸå› ï¼š

- `time.sleep(3)` æ˜¯**çœŸæ­£çš„é˜»å¡è°ƒç”¨**ï¼›
- å®ƒä¼šè®©æ•´ä¸ªäº‹ä»¶å¾ªç¯å¡ä½ï¼Œå¯¼è‡´å…¶ä»–åç¨‹æ— æ³•è¿è¡Œï¼›
- åªæœ‰æ”¹ç”¨ `await asyncio.sleep(3)`ï¼ˆå¼‚æ­¥ç­‰å¾…ï¼‰ï¼Œæ‰ä¸ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ã€‚

âœ… **ç»“è®ºï¼š**

> åœ¨å¼‚æ­¥ï¼ˆåç¨‹ï¼‰ç¨‹åºä¸­ï¼Œä¸€ä¸ªâ€œé˜»å¡æ“ä½œâ€å¯èƒ½è®©**æ•´ä¸ªäº‹ä»¶å¾ªç¯éƒ½æš‚åœ**ï¼Œä»è€Œæ‰€æœ‰åç¨‹éƒ½æ— æ³•æ‰§è¡Œã€‚

##### 3.3 é˜»å¡ä¸çº¿ç¨‹æ± çš„å…³ç³»

å‡è®¾ä½ æœ‰ä¸€ä¸ªçº¿ç¨‹æ± ï¼ˆæ¯”å¦‚ 10 ä¸ªçº¿ç¨‹ï¼‰ï¼š

- å¦‚æœå…¶ä¸­ 1 ä¸ªçº¿ç¨‹é˜»å¡ï¼Œåªæ˜¯**é‚£ä¸€ä¸ªçº¿ç¨‹**åœ¨ç­‰ï¼›
- å…¶ä»– 9 ä¸ªçº¿ç¨‹ä»ç„¶å¯ä»¥ç»§ç»­æ‰§è¡Œï¼›
- é™¤éä½ æäº¤çš„æ‰€æœ‰ä»»åŠ¡éƒ½é˜»å¡ï¼Œé‚£æ•´ä¸ªçº¿ç¨‹æ± çœ‹èµ·æ¥å°±â€œæ²¡ååº”â€äº†ã€‚

```python
from concurrent.futures import ThreadPoolExecutor
import time

def slow_task(n):
    print(f"çº¿ç¨‹ {n} å¼€å§‹")
    time.sleep(3)  # é˜»å¡å½“å‰çº¿ç¨‹
    print(f"çº¿ç¨‹ {n} ç»“æŸ")

with ThreadPoolExecutor(max_workers=3) as pool:
    for i in range(6):
        pool.submit(slow_task, i)
```

ğŸ” è§£é‡Šï¼š

- åŒæ—¶æœ€å¤š 3 ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼›
- è¿™ 3 ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œåï¼Œçº¿ç¨‹æ± å†ç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡ï¼›
- çº¿ç¨‹æ± æ•´ä½“æ²¡æœ‰è¢«â€œé”æ­»â€ï¼Œåªæ˜¯â€œå¿™ç¢Œâ€ã€‚

âœ… **ç»“è®ºï¼š**

> çº¿ç¨‹æ± ä¸­ä¸€ä¸ªçº¿ç¨‹é˜»å¡ï¼Œä¸ä¼šè®©æ•´ä¸ªæ± åœæ‰ï¼Œé™¤éæ‰€æœ‰çº¿ç¨‹éƒ½é˜»å¡ã€‚

#### 4. ä¸Šä¸‹æ–‡ç®¡ç†

##### 4.1. **ä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®ï¼ˆContext Manager Protocolï¼‰**

ä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®é€šå¸¸é€šè¿‡ `__enter__` å’Œ `__exit__` æ–¹æ³•å®ç°ã€‚å¸¸è§çš„ç”¨æ³•æ˜¯ï¼š

```
with some_resource as resource:
    # ä½¿ç”¨ resource
```

è¿™ä¸ª `with` è¯­å¥ä¼šè°ƒç”¨èµ„æºçš„ `__enter__` æ–¹æ³•ï¼Œå¹¶åœ¨ `with` ä»£ç å—æ‰§è¡Œå®Œæ¯•åè°ƒç”¨ `__exit__` æ–¹æ³•ï¼Œä»¥ç¡®ä¿èµ„æºå¾—åˆ°æ­£ç¡®çš„ç®¡ç†å’Œé‡Šæ”¾ã€‚

##### 4.2. **å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆAsync Context Managerï¼‰**

å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®ä¸å¸¸è§„ä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®éå¸¸ç›¸ä¼¼ï¼Œä½†å®ƒéœ€è¦ä½¿ç”¨ `async def` å®šä¹‰ `__aenter__` å’Œ `__aexit__` æ–¹æ³•ã€‚å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨é€‚ç”¨äºé‚£äº›éœ€è¦å¼‚æ­¥æ“ä½œçš„èµ„æºï¼Œå¦‚å¼‚æ­¥æ•°æ®åº“è¿æ¥ã€å¼‚æ­¥æ–‡ä»¶æ“ä½œç­‰ã€‚

- **`__aenter__`**ï¼šå¼‚æ­¥å…¥å£æ–¹æ³•ï¼Œç”¨äºè¿›å…¥ä¸Šä¸‹æ–‡ã€‚
- **`__aexit__`**ï¼šå¼‚æ­¥é€€å‡ºæ–¹æ³•ï¼Œç”¨äºé€€å‡ºä¸Šä¸‹æ–‡å¹¶å¤„ç†æ¸…ç†å·¥ä½œã€‚

##### 4.3. **`async with` çš„å·¥ä½œåŸç†**

`async with` è¯­å¥çš„å·¥ä½œåŸç†ä¸æ™®é€šçš„ `with` ç±»ä¼¼ï¼Œåªæ˜¯å®ƒæ˜¯å¼‚æ­¥çš„ï¼Œä½¿ç”¨ `await` æ¥ç­‰å¾…å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„èµ„æºåˆå§‹åŒ–å’Œæ¸…ç†æ“ä½œã€‚

ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„ä¸€ä¸ªç®€å•ç¤ºä¾‹ï¼š

```python
import asyncio

class AsyncContextManager:
    async def __aenter__(self):
        print("Entering the context")
        # å¯ä»¥å¼‚æ­¥è¿›è¡ŒæŸäº›æ“ä½œï¼Œä¾‹å¦‚æ‰“å¼€å¼‚æ­¥æ–‡ä»¶æˆ–ç½‘ç»œè¿æ¥
        await asyncio.sleep(1)
        return self  # è¿”å›ä½ æƒ³è¦çš„èµ„æº

    async def __aexit__(self, exc_type, exc, tb):
        print("Exiting the context")
        # å¯ä»¥å¼‚æ­¥è¿›è¡Œèµ„æºæ¸…ç†æ“ä½œ
        await asyncio.sleep(1)

async def main():
    async with AsyncContextManager() as manager:
        print("Inside the context")
        await asyncio.sleep(1)
    print("Outside the context")

asyncio.run(main())
```

è¾“å‡ºï¼š

```
Entering the context
Inside the context
Exiting the context
Outside the context
```

è¿™é‡Œçš„ `AsyncContextManager` å®ç°äº†å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®ã€‚`__aenter__` å’Œ `__aexit__` æ–¹æ³•è¢«å®šä¹‰ä¸ºå¼‚æ­¥å‡½æ•°ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥æ‰§è¡Œå¼‚æ­¥æ“ä½œã€‚åœ¨ `async with` è¯­å¥å—å†…ï¼Œ`__aenter__` è¢«è°ƒç”¨ï¼Œè€Œåœ¨ä»£ç å—ç»“æŸåï¼Œ`__aexit__` è¢«è°ƒç”¨ã€‚

##### 4.4. **`async with` çš„åº”ç”¨åœºæ™¯**

`async with` ä¸»è¦ç”¨äºå¼‚æ­¥èµ„æºç®¡ç†ï¼Œç‰¹åˆ«æ˜¯åœ¨ I/O å¯†é›†å‹ä»»åŠ¡ä¸­ã€‚å¸¸è§çš„åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š

- å¼‚æ­¥æ•°æ®åº“è¿æ¥å’ŒæŸ¥è¯¢
- å¼‚æ­¥ç½‘ç»œè¯·æ±‚
- å¼‚æ­¥æ–‡ä»¶æ“ä½œ
- å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—

##### 4.5. **åº“ä¸­çš„å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨**

è®¸å¤šå¼‚æ­¥åº“ï¼ˆå¦‚ `asyncio`, `aiohttp`, `aiomysql`, `aiopg` ç­‰ï¼‰å®ç°äº†å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œç®€åŒ–äº†èµ„æºç®¡ç†ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ `aiohttp` è¿›è¡Œå¼‚æ­¥ HTTP è¯·æ±‚æ—¶ï¼Œ`async with` å¯ä»¥è‡ªåŠ¨ç®¡ç†è¿æ¥æ± å’Œä¼šè¯ï¼š

```python
import aiohttp
import asyncio

async def fetch(url):
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            return await response.text()

async def main():
    url = 'http://example.com'
    html = await fetch(url)
    print(html)

asyncio.run(main())
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`aiohttp.ClientSession()` å’Œ `session.get()` éƒ½æ˜¯å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œç¡®ä¿åœ¨ä½¿ç”¨å®Œä¹‹åè‡ªåŠ¨å…³é—­ HTTP è¿æ¥ã€‚

### äºŒã€JUC å¸¸ç”¨åŒ…

#### 1. ThreadPoolExecutor - çº¿ç¨‹æ± æ ¸å¿ƒå®ç°

æ¦‚å¿µ

**çº¿ç¨‹æ± **æ˜¯ä¸€ç§**çº¿ç¨‹å¤ç”¨æœºåˆ¶**ï¼Œç”¨äºç®¡ç†å’Œè°ƒåº¦å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œã€‚ç®€å•è¯´ï¼Œå®ƒæ˜¯â€œ**æå‰åˆ›å»ºå¥½è‹¥å¹²å·¥ä½œçº¿ç¨‹**â€ï¼Œå½“æœ‰ä»»åŠ¡æäº¤æ—¶ï¼Œå°±ä»æ± é‡Œå–å‡ºç©ºé—²çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œå®Œå†æ”¾å›æ± ä¸­ç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

| ç»„ä»¶                             | ä½œç”¨                     |
| -------------------------------- | ------------------------ |
| **ä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰**       | ä¿å­˜å¾…æ‰§è¡Œçš„ä»»åŠ¡         |
| **å·¥ä½œçº¿ç¨‹ï¼ˆWorker Threadsï¼‰**   | ä¸æ–­ä»é˜Ÿåˆ—å–ä»»åŠ¡æ‰§è¡Œ     |
| **çº¿ç¨‹æ± ç®¡ç†å™¨**                 | è´Ÿè´£åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦çº¿ç¨‹ |
| **æ‹’ç»ç­–ç•¥ï¼ˆRejection Policyï¼‰** | å½“ä»»åŠ¡å¤ªå¤šæ—¶å†³å®šæ€ä¹ˆå¤„ç† |

åŸºæœ¬ç”¨æ³•

```java
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    2, 4, 60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>(100)
);

executor.execute(() -> System.out.println("æ‰§è¡Œä»»åŠ¡"));
executor.shutdown();
```

å¸¸ç”¨æ–¹æ³•

- `execute(Runnable)` - æ‰§è¡Œä»»åŠ¡
- `submit(Callable/Runnable)` - æäº¤ä»»åŠ¡å¹¶è¿”å›Future
- `shutdown()` - ä¼˜é›…å…³é—­
- `getActiveCount()` - è·å–æ´»è·ƒçº¿ç¨‹æ•°

#### 2. Executors - çº¿ç¨‹æ± å·¥å‚ç±»

åŸºæœ¬ç”¨æ³•

```java
// å›ºå®šå¤§å°çº¿ç¨‹æ± 
ExecutorService fixed = Executors.newFixedThreadPool(5);

// ç¼“å­˜çº¿ç¨‹æ± 
ExecutorService cached = Executors.newCachedThreadPool();

// å•çº¿ç¨‹æ± 
ExecutorService single = Executors.newSingleThreadExecutor();
```

å¸¸ç”¨æ–¹æ³•

- `newFixedThreadPool(int)` - åˆ›å»ºå›ºå®šå¤§å°çº¿ç¨‹æ± 
- `newCachedThreadPool()` - åˆ›å»ºç¼“å­˜çº¿ç¨‹æ± 
- `newSingleThreadExecutor()` - åˆ›å»ºå•çº¿ç¨‹æ± 
- `newScheduledThreadPool(int)` - åˆ›å»ºå®šæ—¶çº¿ç¨‹æ± 

#### 3. ScheduledThreadPoolExecutor - å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± 

åŸºæœ¬ç”¨æ³•

```java
ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(2);

// å»¶è¿Ÿæ‰§è¡Œ
scheduler.schedule(() -> System.out.println("å»¶è¿Ÿä»»åŠ¡"), 5, TimeUnit.SECONDS);

// å‘¨æœŸæ‰§è¡Œ
scheduler.scheduleAtFixedRate(() -> System.out.println("å‘¨æœŸä»»åŠ¡"), 0, 2, TimeUnit.SECONDS);
```

å¸¸ç”¨æ–¹æ³•

- `schedule(Runnable, delay, unit)` - å»¶è¿Ÿæ‰§è¡Œ
- `scheduleAtFixedRate(Runnable, initialDelay, period, unit)` - å›ºå®šé¢‘ç‡æ‰§è¡Œ
- `scheduleWithFixedDelay(Runnable, initialDelay, delay, unit)` - å›ºå®šå»¶è¿Ÿæ‰§è¡Œ

#### 4.CompletableFuture - å¼‚æ­¥ç¼–ç¨‹

åŸºæœ¬ç”¨æ³•

```java
CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> {
    return "å¼‚æ­¥ç»“æœ";
});

future.thenAccept(System.out::println);
String result = future.get(); // é˜»å¡è·å–ç»“æœ
```

å¸¸ç”¨æ–¹æ³•

- `supplyAsync(Supplier)` - å¼‚æ­¥æ‰§è¡Œæœ‰è¿”å›å€¼ä»»åŠ¡
- `runAsync(Runnable)` - å¼‚æ­¥æ‰§è¡Œæ— è¿”å›å€¼ä»»åŠ¡
- `thenApply(Function)` - ç»“æœè½¬æ¢
- `thenAccept(Consumer)` - æ¶ˆè´¹ç»“æœ

#### 5. ReentrantLock - å¯é‡å…¥é”

åŸºæœ¬ç”¨æ³•

```java
ReentrantLock lock = new ReentrantLock();

lock.lock();
try {
    // ä¸´ç•ŒåŒºä»£ç 
} finally {
    lock.unlock();
}
```

å¸¸ç”¨æ–¹æ³•

- `lock()` - è·å–é”
- `unlock()` - é‡Šæ”¾é”
- `tryLock()` - å°è¯•è·å–é”
- `newCondition()` - åˆ›å»ºæ¡ä»¶å˜é‡

#### 6. CountDownLatch - å€’è®¡æ—¶é—¨é—©

åŸºæœ¬ç”¨æ³•

```java
CountDownLatch latch = new CountDownLatch(3);

// å·¥ä½œçº¿ç¨‹
new Thread(() -> {
    // æ‰§è¡Œä»»åŠ¡
    latch.countDown();
}).start();

// ä¸»çº¿ç¨‹ç­‰å¾…
latch.await();
```

å¸¸ç”¨æ–¹æ³•

- `await()` - ç­‰å¾…è®¡æ•°å½’é›¶
- `countDown()` - è®¡æ•°å‡1
- `getCount()` - è·å–å½“å‰è®¡æ•°
- `await(timeout, unit)` - è¶…æ—¶ç­‰å¾…

#### 7. Semaphore - ä¿¡å·é‡

åŸºæœ¬ç”¨æ³•

```java
Semaphore semaphore = new Semaphore(3); // å…è®¸3ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®

semaphore.acquire();
try {
    // è®¿é—®å…±äº«èµ„æº
} finally {
    semaphore.release();
}
```

å¸¸ç”¨æ–¹æ³•

- `acquire()` - è·å–è®¸å¯
- `release()` - é‡Šæ”¾è®¸å¯
- `tryAcquire()` - å°è¯•è·å–è®¸å¯
- `availablePermits()` - å¯ç”¨è®¸å¯æ•°

#### 8. Exchanger - ä¸¤çº¿ç¨‹æ•°æ®äº¤æ¢

åŸºæœ¬ç”¨æ³•

```java
Exchanger<String> exchanger = new Exchanger<>();

// çº¿ç¨‹1
new Thread(() -> {
    try {
        String received = exchanger.exchange("æ•°æ®1");
        System.out.println("æ”¶åˆ°: " + received);
    } catch (InterruptedException e) {}
}).start();

// çº¿ç¨‹2
new Thread(() -> {
    try {
        String received = exchanger.exchange("æ•°æ®2");
        System.out.println("æ”¶åˆ°: " + received);
    } catch (InterruptedException e) {}
}).start();
```

å¸¸ç”¨æ–¹æ³•

- `exchange(V)` - äº¤æ¢æ•°æ®å¹¶ç­‰å¾…
- `exchange(V, timeout, unit)` - è¶…æ—¶äº¤æ¢

#### 9. ConcurrentHashMap - çº¿ç¨‹å®‰å…¨å“ˆå¸Œè¡¨

åŸºæœ¬ç”¨æ³•

```java
ConcurrentHashMap<String, Integer> map = new ConcurrentHashMap<>();

map.put("key1", 1);
Integer value = map.get("key1");
map.putIfAbsent("key2", 2);
map.compute("key1", (k, v) -> v + 1);
```

å¸¸ç”¨æ–¹æ³•

- `put(K, V)` - æ·»åŠ å…ƒç´ 
- `get(K)` - è·å–å…ƒç´ 
- `putIfAbsent(K, V)` - ä¸å­˜åœ¨æ—¶æ·»åŠ 
- `compute(K, BiFunction)` - è®¡ç®—æ–°å€¼

#### 10. Future/FutureTask - å¼‚æ­¥è®¡ç®—ç»“æœ

åŸºæœ¬ç”¨æ³•

```java
// ä½¿ç”¨Future
ExecutorService executor = Executors.newSingleThreadExecutor();
Future<String> future = executor.submit(() -> "å¼‚æ­¥ç»“æœ");
String result = future.get();

// ä½¿ç”¨FutureTask
FutureTask<String> task = new FutureTask<>(() -> "ä»»åŠ¡ç»“æœ");
new Thread(task).start();
String taskResult = task.get();
```

å¸¸ç”¨æ–¹æ³•

- `get()` - é˜»å¡è·å–ç»“æœ
- `get(timeout, unit)` - è¶…æ—¶è·å–ç»“æœ
- `isDone()` - åˆ¤æ–­æ˜¯å¦å®Œæˆ
- `cancel(boolean)` - å–æ¶ˆä»»åŠ¡

### ä¸‰ã€webscraperä¸­ä½¿ç”¨çš„å¹¶å‘

#### 1. æµè§ˆå™¨æ± 

è®¾è®¡æ€è·¯ï¼šæµè§ˆå™¨å®ä¾‹å¤ç”¨ï¼ŒèŠ‚çœ2.5ç§’/URLï¼›è‡ªåŠ¨ç®¡ç†é¡µé¢èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼›ä¿¡å·é‡æ§åˆ¶æ¯ä¸ªæµè§ˆå™¨çš„é¡µé¢æ•°ï¼Œé˜²æ­¢è¿‡è½½ï¼›ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¿è¯é¡µé¢è‡ªåŠ¨å…³é—­ï¼› æ”¯æŒé™çº§ï¼Œå‘åå…¼å®¹

é—®é¢˜åˆ†æï¼š

å½“å‰æ¯ä¸ª `extract_xxx` å‡½æ•°éƒ½ç‹¬ç«‹åˆ›å»ºbrowserï¼š
```python
async with async_playwright() as p:
    browser = await p.chromium.launch()  # æ¯æ¬¡2ç§’
    # ... ä½¿ç”¨
    await browser.close()  # æ¯æ¬¡0.5ç§’
```

**ç—›ç‚¹**ï¼š50ä¸ªURL Ã— 2.5ç§’ = 125ç§’æµªè´¹åœ¨æµè§ˆå™¨åˆ›å»º/é”€æ¯ä¸Š

è§£å†³æ–¹æ¡ˆï¼šåˆ›å»ºå•ç½‘ç«™æµè§ˆå™¨æ± 

**æ–°å»ºæ–‡ä»¶ï¼š`crawler/sites_shopping/browser_pool.py`**

```python
"""
å•ç½‘ç«™Playwrightæµè§ˆå™¨è¿æ¥æ± 
ç”Ÿå‘½å‘¨æœŸï¼šç½‘ç«™å¼€å§‹æ—¶åˆ›å»º â†’ å¤„ç†æ‰€æœ‰URL â†’ ç½‘ç«™ç»“æŸæ—¶é”€æ¯
"""
import asyncio
from playwright.async_api import async_playwright, Browser, Page
from typing import Optional, List
from contextlib import asynccontextmanager
from config import logger

class BrowserPool:
    """å•ç½‘ç«™Playwrightæµè§ˆå™¨è¿æ¥æ± """

    def __init__(self, pool_size: int = 3, max_pages_per_browser: int = 5):
        """
        åˆå§‹åŒ–æµè§ˆå™¨æ± 

        Args:
            pool_size: æµè§ˆå™¨å®ä¾‹æ•°é‡ï¼ˆé»˜è®¤3ä¸ªï¼‰
            max_pages_per_browser: æ¯ä¸ªæµè§ˆå™¨æœ€å¤šæ‰“å¼€çš„é¡µé¢æ•°ï¼ˆé»˜è®¤5ä¸ªï¼‰
        """
        self.pool_size = pool_size
        self.max_pages_per_browser = max_pages_per_browser

        self.playwright = None
        self.browsers: List[Browser] = []
        self.page_semaphores: List[asyncio.Semaphore] = []
        self.initialized = False
        self.current_browser_index = 0  # è½®è¯¢ç´¢å¼•

    async def initialize(self):
        """åˆå§‹åŒ–æµè§ˆå™¨æ± ï¼ˆç½‘ç«™å¼€å§‹æ—¶è°ƒç”¨ï¼‰"""
        if self.initialized:
            return

        logger.info(f"ğŸš€ åˆå§‹åŒ–æµè§ˆå™¨æ± : {self.pool_size} ä¸ªæµè§ˆå™¨")

        self.playwright = await async_playwright().start()

        for i in range(self.pool_size):
            browser = await self.playwright.chromium.launch(
                headless=True,
                # å¯é€‰ï¼šæ·»åŠ å¯åŠ¨å‚æ•°ä¼˜åŒ–æ€§èƒ½
                args=['--disable-blink-features=AutomationControlled']
            )
            self.browsers.append(browser)

            # æ¯ä¸ªæµè§ˆå™¨æœ‰ç‹¬ç«‹çš„é¡µé¢ä¿¡å·é‡
            self.page_semaphores.append(
                asyncio.Semaphore(self.max_pages_per_browser)
            )
            logger.info(f"  âœ… æµè§ˆå™¨ #{i+1} å·²å¯åŠ¨")

        self.initialized = True
        logger.info("âœ… æµè§ˆå™¨æ± åˆå§‹åŒ–å®Œæˆ")

    @asynccontextmanager
    async def get_page(self):
        """
        è·å–ä¸€ä¸ªé¡µé¢ï¼ˆä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼‰

        Yields:
            Page: Playwrighté¡µé¢å¯¹è±¡

        ä½¿ç”¨ç¤ºä¾‹ï¼š
            async with browser_pool.get_page() as page:
                await page.goto(url)
                content = await page.content()
        """
        if not self.initialized:
            await self.initialize()

        # è½®è¯¢é€‰æ‹©æµè§ˆå™¨ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
        browser_index = self.current_browser_index % self.pool_size
        self.current_browser_index += 1

        browser = self.browsers[browser_index]
        semaphore = self.page_semaphores[browser_index]

        # ç­‰å¾…è·å–é¡µé¢èµ„æº
        async with semaphore:
            page = await browser.new_page()

            # è®¾ç½®é»˜è®¤çš„User-Agent
            await page.set_extra_http_headers({
                'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) '
                             'AppleWebKit/537.36 (KHTML, like Gecko) '
                             'Chrome/120.0.0.0 Safari/537.36'
            })

            try:
                yield page
            finally:
                # ç¡®ä¿é¡µé¢å…³é—­
                await page.close()

    async def close(self):
        """å…³é—­æµè§ˆå™¨æ± ï¼ˆç½‘ç«™ç»“æŸæ—¶è°ƒç”¨ï¼‰"""
        if not self.initialized:
            return

        logger.info("ğŸ”’ å…³é—­æµè§ˆå™¨æ± ...")

        for i, browser in enumerate(self.browsers):
            await browser.close()
            logger.info(f"  âœ… æµè§ˆå™¨ #{i+1} å·²å…³é—­")

        if self.playwright:
            await self.playwright.stop()

        self.browsers.clear()
        self.page_semaphores.clear()
        self.initialized = False

        logger.info("âœ… æµè§ˆå™¨æ± å·²å…³é—­")
```

åœ¨ extractor_llm.py ä¸­é›†æˆæµè§ˆå™¨æ± ï¼š

**ShoppingLLM ç±»æ·»åŠ æµè§ˆå™¨æ± ç®¡ç†ï¼š**
```python
class ShoppingLLM:
    def __init__(self, ..., enable_concurrent=False):
        # ... åŸæœ‰åˆå§‹åŒ–
        self.enable_concurrent = enable_concurrent
        self.browser_pool = None  # æµè§ˆå™¨è¿æ¥æ± 

    async def initialize_browser_pool(self):
        """åˆå§‹åŒ–æµè§ˆå™¨æ± ï¼ˆç½‘ç«™å¼€å§‹æ—¶ï¼‰"""
        if self.browser_pool is None:
            from .browser_pool import BrowserPool
            self.browser_pool = BrowserPool(
                pool_size=CONCURRENT_CONFIG['browser_pool_size'],
                max_pages_per_browser=CONCURRENT_CONFIG['max_pages_per_browser']
            )
            await self.browser_pool.initialize()

    async def close_browser_pool(self):
        """å…³é—­æµè§ˆå™¨æ± ï¼ˆç½‘ç«™ç»“æŸæ—¶ï¼‰"""
        if self.browser_pool:
            await self.browser_pool.close()
            self.browser_pool = None
```

ä¿®æ”¹å„ extractor_xxx.py ä½¿ç”¨æµè§ˆå™¨æ± ï¼š

**ä¿®æ”¹å‰ï¼ˆextractor_slickdeals.pyï¼‰ï¼š**
```python
async def extract_deals_from_slickdeals(url, extract_by_llm=False):
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)  # 2ç§’
        page = await browser.new_page()
        # ... çˆ¬å–é€»è¾‘
        await browser.close()  # 0.5ç§’
```

**ä¿®æ”¹åï¼š**
```python
async def extract_deals_from_slickdeals(url, extract_by_llm=False, browser_pool=None):
    """
    æ·»åŠ  browser_pool å‚æ•°ï¼Œç”± extractor_llm ä¼ å…¥
    """
    if browser_pool:
        # ä½¿ç”¨ä¼ å…¥çš„æµè§ˆå™¨æ± 
        async with browser_pool.get_page() as page:
            # ... çˆ¬å–é€»è¾‘ï¼ˆå…¶ä»–ä¸å˜ï¼‰
            await page.goto(url, wait_until='domcontentloaded')
            content = await page.content()
            # ...
    else:
        # é™çº§ï¼šå¦‚æœæ²¡æœ‰æµè§ˆå™¨æ± ï¼Œä½¿ç”¨åŸæœ‰æ–¹å¼
        async with async_playwright() as p:
            browser = await p.chromium.launch(headless=True)
            page = await browser.new_page()
            # ... çˆ¬å–é€»è¾‘
            await browser.close()
```

**åœ¨ extractor_llm.py è°ƒç”¨æ—¶ä¼ å…¥ï¼š**
```python
async def run_as_preset(self, url, parent=None, extract_by_llm=False):
    # ... åŸæœ‰é€»è¾‘
    func = func_dic.get('page')
    # ä¼ å…¥æµè§ˆå™¨æ± 
    res, site_info = await func(url, browser_pool=self.browser_pool)
    # ...
```

#### 2. åç¨‹å¹¶å‘

æ·»åŠ  `enable_concurrent` å‚æ•°ï¼Œæ”¯æŒæ¸è¿›å¼å‡çº§ï¼› ä½¿ç”¨ `asyncio.Semaphore` é™åˆ¶å¹¶å‘æ•°ï¼›åˆ†æ‰¹æ‰§è¡Œé¿å…ä»»åŠ¡è¿‡å¤šï¼›ä¿ç•™åŸä¸²è¡Œæ–¹æ³•ä½œä¸ºfallback

```python
class ShoppingLLM:
    def __init__(self, ..., enable_concurrent=False):
        # ... åŸæœ‰åˆå§‹åŒ–
        self.enable_concurrent = enable_concurrent
        self.url_semaphore = asyncio.Semaphore(
            CONCURRENT_CONFIG['max_urls_per_site']
        ) if enable_concurrent else None
        self.browser_pool = None  # æµè§ˆå™¨è¿æ¥æ± ï¼ˆåç»­å®ç°ï¼‰

    async def process_level_urls_concurrent(self, level):
        """å¹¶å‘å¤„ç†æŒ‡å®šå±‚çº§çš„æ‰€æœ‰URL"""
        logger.info(f"ğŸ“‹ å¼€å§‹å¹¶å‘å¤„ç† Level {level}")

        # 1. æ”¶é›†å½“å‰å±‚çº§çš„æ‰€æœ‰URL
        level_urls = []
        temp_queue = deque()
        while self.url_queue:
            url, parent, url_level = self.url_queue.popleft()
            if url_level == level:
                level_urls.append((url, parent, url_level))
            else:
                temp_queue.append((url, parent, url_level))
        self.url_queue = temp_queue

        if not level_urls:
            return

        logger.info(f"ğŸ“Š Level {level}: {len(level_urls)} ä¸ªURLå¾…å¤„ç†")

        # 2. åˆ›å»ºå¹¶å‘ä»»åŠ¡ï¼ˆå¸¦ä¿¡å·é‡æ§åˆ¶ï¼‰
        async def process_url_with_semaphore(url, parent, url_level):
            """å¸¦ä¿¡å·é‡æ§åˆ¶çš„URLå¤„ç†"""
            async with self.url_semaphore:
                if url in self.visited_urls:
                    return

                self.visited_urls.add(url)
                logger.info(f"ğŸ”„ å¤„ç†URL: {url}")

                try:
                    await self.analyze_single_url(url, parent, url_level)
                    logger.info(f"âœ… å®ŒæˆURL: {url}")
                except Exception as e:
                    logger.error(f"âŒ URLå¤„ç†å¤±è´¥ {url}: {e}")

        # 3. åˆ›å»ºæ‰€æœ‰ä»»åŠ¡
        tasks = [
            asyncio.create_task(
                process_url_with_semaphore(url, parent, url_level)
            )
            for url, parent, url_level in level_urls
            if url not in self.visited_urls
        ]

        # 4. åˆ†æ‰¹æ‰§è¡Œï¼ˆé¿å…ä¸€æ¬¡æ€§æäº¤å¤ªå¤šä»»åŠ¡ï¼‰
        batch_size = CONCURRENT_CONFIG['max_urls_per_site'] * 2
        for i in range(0, len(tasks), batch_size):
            batch = tasks[i:i + batch_size]
            await asyncio.gather(*batch, return_exceptions=True)
            logger.info(f"  æ‰¹æ¬¡ {i//batch_size + 1} å®Œæˆ")

    async def analyze(self, url, parent=None):
        """åˆ†æURLçš„ä¸»æ–¹æ³•ï¼ˆæ”¯æŒå¹¶å‘ï¼‰"""
        logger.info(f"ğŸ” å¼€å§‹åˆ†æ: {url}")
        await self.add_url_to_queue(url, parent=parent, level=0)

        # é€å±‚å¤„ç†
        for level in range(self.max_level + 1):
            if not self.url_queue:
                break

            self.current_level = level
            logger.info(f"ğŸ”„ å¤„ç† Level {level}...")

            # æ ¹æ®é…ç½®é€‰æ‹©å¹¶å‘æˆ–ä¸²è¡Œ
            if self.enable_concurrent:
                await self.process_level_urls_concurrent(level)
            else:
                await self.process_level_urls(level)  # ä¿ç•™åŸä¸²è¡Œæ–¹æ³•

            logger.info(f"âœ… Level {level} å®Œæˆ")

        logger.info(f"ğŸ‰ åˆ†æå®Œæˆ: å…±å¤„ç† {len(self.visited_urls)} ä¸ªURL")
```

#### 3. Gemini åŸç”Ÿå¼‚æ­¥

1. âœ… **çœŸæ­£çš„å¼‚æ­¥ I/O**
   - `await chat.aio.send_message()` æ˜¯éé˜»å¡è°ƒç”¨
   - ç½‘ç»œè¯·æ±‚æ—¶é‡Šæ”¾äº‹ä»¶å¾ªç¯ï¼Œå¯ä»¥å¤„ç†å…¶ä»–ä»»åŠ¡

2. âœ… **æ— çº¿ç¨‹æ± é™åˆ¶**
   - ç›´æ¥åœ¨äº‹ä»¶å¾ªç¯ä¸­è¿è¡Œ
   - 20 å¹¶å‘ = 20 åç¨‹ï¼Œå…¨éƒ¨åŒæ—¶æ‰§è¡Œ

3. âœ… **å†…å­˜å ç”¨ä½**
   - æ¯ä¸ªåç¨‹ ~1KB
   - 20 ä¸ªåç¨‹ = 20KB

```python
async def _async_chat_with_continuation(...):
    from google import genai
    from google.genai import types

    # åˆ›å»ºå¼‚æ­¥å®¢æˆ·ç«¯
    client = genai.Client(api_key=api_key)

    try:
        # åˆ›å»º Chat ä¼šè¯
        chat = client.chats.create(model='gemini-2.5-flash')

        # âœ… åŸç”Ÿå¼‚æ­¥è°ƒç”¨ï¼ˆä¸é˜»å¡ï¼‰
        response = await chat.aio.send_message(prompt, config=...)

        # æ”¯æŒ continuationï¼ˆå¤šè½®å¯¹è¯ï¼‰
        if is_truncated(response.text):
            response2 = await chat.aio.send_message("continue", ...)
            merged = merge_fragments([response.text, response2.text])

        return json.loads(merged)

    finally:
        # å…³é—­å¼‚æ­¥å®¢æˆ·ç«¯
        await client.aio.aclose()
```

geminiåŸç”Ÿå¼‚æ­¥åœ¨æ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºå®¢æˆ·ç«¯ï¼Œä¸”ä¸æ”¯æŒ async with ä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®ï¼Œéœ€è¦ GeminiClientPool ç±»æ¥ç®¡ç†

```python
# ä»å…¨å±€æ± è·å– Clientï¼ˆèµ„æºå¤ç”¨ï¼‰
client_pool = await get_client_pool()
client = await client_pool.get_client(api_key)
try:
    chat = client.aio.chats.create(model='gemini-2.5-flash')
    # ... ä½¿ç”¨ Client
finally:
    # é‡Šæ”¾ Clientï¼ˆå‡å°‘æ´»è·ƒè®¡æ•°ï¼‰
    await client_pool.release_client(api_key)
```

**èµ„æºæ¸…ç†æ–¹æ³•ï¼š**

1. **è‡ªåŠ¨æ¸…ç†ï¼ˆatexitï¼‰**ï¼š
   - ç¨‹åºé€€å‡ºæ—¶è‡ªåŠ¨è°ƒç”¨ `_sync_cleanup()`
   - é€‚é…ä¸åŒçš„äº‹ä»¶å¾ªç¯çŠ¶æ€

2. **æ˜¾å¼æ¸…ç†**ï¼š
   - æä¾› `cleanup_client_pool()` å‡½æ•°
   - å¯åœ¨ç¨‹åºæ­£å¸¸ç»“æŸæ—¶ä¸»åŠ¨è°ƒç”¨

3. **é‡æ–°åˆå§‹åŒ–**ï¼š
   - æ¸…ç†åå¯ä»¥é‡æ–°ä½¿ç”¨æ± 
   - è‡ªåŠ¨æ£€æµ‹å¹¶é‡æ–°åˆå§‹åŒ–

#### 4. æµç¨‹å›¾

é€šè¿‡ LLM æ± å¯ä»¥æ§åˆ¶å¹¶å‘é€Ÿç‡ï¼Œä¿è¯ key å¯ä»¥è½®æ¢ï¼ŒåŒæ—¶å¯ä»¥è¿›è¡Œç»Ÿè®¡å’Œç›‘æ§

```mermaid
flowchart TD

    subgraph APP["åº”ç”¨å±‚ï¼ˆExtractorï¼‰"]
        A1["ç½‘ç«™Açˆ¬å– â†’ ç”ŸæˆMarkdown"]
        A2["ç½‘ç«™Bçˆ¬å– â†’ ç”ŸæˆMarkdown"]
        A3["ç½‘ç«™Cçˆ¬å– â†’ ç”ŸæˆMarkdown"]
        A1 -->|æäº¤ä»»åŠ¡| Q["å…¨å±€LLMæ± "]
        A2 -->|æäº¤ä»»åŠ¡| Q
        A3 -->|æäº¤ä»»åŠ¡| Q
    end

    subgraph LLMPOOL["å…¨å±€LLMæ± ç®¡ç†å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"]
        subgraph QUEUE["æ— ç•Œä»»åŠ¡é˜Ÿåˆ—ï¼ˆasyncio.Queueï¼‰"]
            Q1["æ‰€æœ‰ç½‘ç«™çš„Markdownä»»åŠ¡æ”¾å…¥æ­¤é˜Ÿåˆ—"]
            Q2["FIFO é¡ºåºå¤„ç†"]
        end

        subgraph WORKERS["20ä¸ª Worker åç¨‹å¹¶å‘å¤„ç†"]
            W1["ä»é˜Ÿåˆ—å–ä»»åŠ¡ â†’ è·å–Key â†’ è°ƒAPI â†’ è¿”å›ç»“æœ"]
            W2["Semaphoreæ§åˆ¶æœ€å¤§å¹¶å‘æ•° = 20"]
        end

        subgraph KEYROTATOR["API Keyè½®æ¢å™¨"]
            K1["Key1: AIzaSy...CAï¼ˆ50%æµé‡ï¼‰"]
            K2["Key2: AIzaSy...nQï¼ˆ50%æµé‡ï¼‰"]
            K3["Round Robinè½®è¯¢ + å¥åº·æ£€æŸ¥ + æ•…éšœåˆ‡æ¢"]
        end

        subgraph GEMINI["Gemini APIè°ƒç”¨ï¼ˆclient.aio åŸç”Ÿå¼‚æ­¥ï¼‰"]
            G1["è¶…æ—¶æ§åˆ¶ï¼š120ç§’"]
            G2["é‡è¯•æœºåˆ¶ï¼š3æ¬¡ï¼ˆæŒ‡æ•°é€€é¿ï¼‰"]
            G3["Rate Limitå¤„ç†ï¼šè‡ªåŠ¨åˆ‡æ¢Key"]
            G4["çœŸæ­£çš„å¼‚æ­¥ I/Oï¼ˆä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼‰"]
        end
    end

    APP --> LLMPOOL
    QUEUE --> WORKERS
    WORKERS --> KEYROTATOR
    KEYROTATOR --> GEMINI
    GEMINI --> R["è¿”å›JSONç»“æœ"]

```

### å››ã€pythonçš„å¹¶å‘ç¼–ç¨‹

#### é›¶ã€GILæ¦‚å¿µ

##### 1. ä»€ä¹ˆæ˜¯ GILï¼Ÿ

**å®šä¹‰**ï¼š
GIL æ˜¯ä¸€ä¸ªäº’æ–¥é”ï¼ˆMutexï¼‰ï¼Œå®ƒç”± Python è§£é‡Šå™¨ï¼ˆCPythonï¼‰ç»´æŠ¤ã€‚
**æ ¸å¿ƒè§„åˆ™**ï¼šåœ¨åŒä¸€æ—¶åˆ»ï¼Œ**åŒä¸€ä¸ª Python è¿›ç¨‹ä¸­ï¼Œæ— è®ºä½ æœ‰å¤šå°‘ä¸ªçº¿ç¨‹ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ CPU ä¸Šæ‰§è¡Œ Python å­—èŠ‚ç ã€‚**

**é€šä¿—ç±»æ¯”**ï¼š
æƒ³è±¡ä¸€å®¶å…¬å¸ï¼ˆè¿›ç¨‹ï¼‰é›‡ä½£äº† 10 ä¸ªå‘˜å·¥ï¼ˆçº¿ç¨‹ï¼‰ï¼Œä½†å…¬å¸é‡Œ**åªæœ‰ä¸€æ”¯ç¬”**ï¼ˆGILï¼‰ã€‚
*   æƒ³è¦å¹²æ´»ï¼ˆæ‰§è¡Œä»£ç ï¼‰ï¼Œå¿…é¡»å…ˆæŠ¢åˆ°è¿™æ”¯ç¬”ã€‚
*   æ‹¿åˆ°ç¬”çš„äººå¹²ä¸€ä¼šå„¿ï¼Œä¼šè¢«å¼ºåˆ¶æŠŠç¬”äº¤å‡ºæ¥ï¼Œè®©å¤§å®¶é‡æ–°æŠ¢ã€‚
*   å¦‚æœä½ çš„å·¥ä½œæ˜¯**æ€è€ƒ**ï¼ˆCPU è®¡ç®—ï¼‰ï¼Œæ²¡ç¬”å°±å¹²ä¸äº†æ´»ï¼Œæ‰€ä»¥å¤§å®¶åªèƒ½è½®æµå¹²ï¼Œæ•ˆç‡æä½ã€‚
*   å¦‚æœä½ çš„å·¥ä½œæ˜¯**æ‰“ç”µè¯**ï¼ˆIO æ“ä½œï¼‰ï¼Œä½ æ‹¨é€šç”µè¯åï¼ˆå‘å‡ºè¯·æ±‚ï¼‰ï¼Œå°±å¯ä»¥æŠŠç¬”æ”¾å›å»è®©åˆ«äººç”¨ï¼Œç­‰ç”µè¯é€šäº†å†æŠ¢ç¬”è®°å½•ã€‚

##### 2. ä¸ºä»€ä¹ˆä¼šæœ‰ GILï¼Ÿï¼ˆå†å²æˆå› ï¼‰

æ—¢ç„¶ GIL é™åˆ¶äº†å¤šæ ¸å¹¶è¡Œï¼Œä¸ºä»€ä¹ˆè®¾è®¡è€…ï¼ˆGuido van Rossumï¼‰å½“åˆè¦åŠ ä¸Šå®ƒï¼Ÿ

**A. å†…å­˜ç®¡ç†ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰**

Python ä½¿ç”¨**å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰**æ¥ç®¡ç†å†…å­˜ã€‚æ¯ä¸ªå¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè®°å½•æœ‰å¤šå°‘ä¸ªå˜é‡æŒ‡å‘å®ƒã€‚
*   `a = 1` ï¼ˆ1 çš„å¼•ç”¨è®¡æ•° +1ï¼‰
*   `del a` ï¼ˆ1 çš„å¼•ç”¨è®¡æ•° -1ï¼Œå½’é›¶æ—¶å›æ”¶å†…å­˜ï¼‰

**é—®é¢˜æ¥äº†**ï¼šå¦‚æœä¸åŠ é”ï¼Œå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ˆä¾‹å¦‚ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ `del a`ï¼‰ï¼Œä¼šå¯¼è‡´è®¡æ•°å™¨é”™ä¹±ï¼Œè¿›è€Œå¯¼è‡´**å†…å­˜æ³„æ¼**ï¼ˆè¯¥åˆ æ²¡åˆ ï¼‰æˆ–**å´©æºƒ**ï¼ˆåˆ äº†ä¸¤æ¬¡ï¼Œé‡æŒ‡é’ˆï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1.  **ç»†ç²’åº¦é”**ï¼šç»™æ¯ä¸ªå¯¹è±¡éƒ½åŠ ä¸€æŠŠé”ã€‚ -> **ç¼ºç‚¹**ï¼šå¤ªæ…¢äº†ï¼Œæ­»é”é£é™©é«˜ã€‚
2.  **å¤§é”ï¼ˆGILï¼‰**ï¼šç»™è§£é‡Šå™¨åŠ ä¸€æŠŠå¤§é”ï¼Œè°æ‰§è¡Œä»£ç è°æ‹¿é”ã€‚ -> **ä¼˜ç‚¹**ï¼šå®ç°ç®€å•ï¼Œè¿è¡Œé€Ÿåº¦å¿«ï¼ˆå•çº¿ç¨‹ä¸‹ï¼‰ï¼Œä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚

**B. C æ‰©å±•åº“çš„å…¼å®¹æ€§**

Python æ—©æœŸä¾èµ–å¤§é‡ C è¯­è¨€å†™çš„æ‰©å±•åº“ã€‚GIL çš„å­˜åœ¨ä¿è¯äº†è¿™äº› C åº“åœ¨ç¼–å†™æ—¶ä¸éœ€è¦è¿‡åº¦è€ƒè™‘å¤æ‚çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œè¿™æå¤§åœ°ä¿ƒè¿›äº† Python ç”Ÿæ€ï¼ˆå¦‚æ—©æœŸ NumPy ç­‰ï¼‰çš„çˆ†å‘ã€‚

##### 3. GIL çš„å…·ä½“å½±å“ï¼šCPU vs IO

è¿™æ˜¯é¢è¯•å’Œå®æˆ˜ä¸­æœ€å…³é”®çš„éƒ¨åˆ†ã€‚

**åœºæ™¯ Aï¼šCPU å¯†é›†å‹ï¼ˆè®¡ç®—ã€å›¾åƒå¤„ç†ã€å¾ªç¯ï¼‰**

*   **è¡¨ç°**ï¼šå¤šçº¿ç¨‹ **â‰ˆ** å•çº¿ç¨‹ï¼ˆç”šè‡³æ›´æ…¢ï¼‰ã€‚
*   **åŸå› **ï¼š
    1.  çº¿ç¨‹ A æ‹¿åˆ° GILï¼Œå¼€å§‹è®¡ç®—ã€‚
    2.  æ‰§è¡Œä¸€æ®µæ—¶é—´åï¼ˆé»˜è®¤æ˜¯ check intervalï¼‰ï¼Œè§£é‡Šå™¨å¼ºåˆ¶æŒ‚èµ· Aï¼Œé‡Šæ”¾ GILã€‚
    3.  çº¿ç¨‹ B æŠ¢åˆ° GILï¼Œå¼€å§‹è®¡ç®—ã€‚
    4.  **é¢å¤–å¼€é”€**ï¼šçº¿ç¨‹åˆ‡æ¢ï¼ˆContext Switchï¼‰å’ŒæŠ¢é”æœ¬èº«éƒ½éœ€è¦æ¶ˆè€—èµ„æºã€‚
*   **ç»“è®º**ï¼š**ä¸è¦ç”¨å¤šçº¿ç¨‹åš CPU è®¡ç®—ï¼** **è¿™ç§æƒ…å†µä¸‹ sync æ¯” async è¦å¿«**

**åœºæ™¯ Bï¼šIO å¯†é›†å‹ï¼ˆçˆ¬è™«ã€è¯»å†™æ–‡ä»¶ã€APIè°ƒç”¨ï¼‰**

*   **è¡¨ç°**ï¼šå¤šçº¿ç¨‹ **>** å•çº¿ç¨‹ï¼ˆæ•ˆæœæ˜¾è‘—ï¼‰ã€‚
*   **åŸå› **ï¼š
    1.  çº¿ç¨‹ A æ‹¿åˆ° GILï¼Œæ‰§è¡Œ `requests.get()`ã€‚
    2.  **å…³é”®ç‚¹**ï¼šå½“ä»£ç æ‰§è¡Œåˆ°ç³»ç»Ÿåº•å±‚çš„ IO è°ƒç”¨ï¼ˆé˜»å¡ç­‰å¾…ï¼‰æ—¶ï¼ŒPython ä¼š**ä¸»åŠ¨é‡Šæ”¾ GIL**ã€‚
    3.  çº¿ç¨‹ A åœ¨ç­‰å¾…ç½‘ç»œæ•°æ®ï¼ˆä¸æ¶ˆè€— CPUï¼‰ï¼Œæ­¤æ—¶çº¿ç¨‹ B æŠ¢åˆ° GIL å»å¹²æ´»ã€‚
    4.  çº¿ç¨‹ A æ•°æ®å›æ¥äº†ï¼Œé‡æ–°ç”³è¯· GIL ç»§ç»­å¤„ç†ã€‚
*   **ç»“è®º**ï¼š**å¤šçº¿ç¨‹éå¸¸é€‚åˆ IO ä»»åŠ¡ã€‚**

##### 4. æ·±å…¥ç†è§£ï¼šGIL çš„é‡Šæ”¾æœºåˆ¶

Python å¹¶ä¸æ˜¯ä¸€ç›´æ­»æ­»æŠ±ç€é”ä¸æ”¾ï¼Œå®ƒæœ‰ä¸¤ç§é‡Šæ”¾æœºåˆ¶ï¼š

1.  **ååŒå¼ï¼ˆCooperativeï¼‰**ï¼šé‡åˆ° IO é˜»å¡ï¼ˆè¯»æ–‡ä»¶ã€ç½‘ç»œã€Sleepï¼‰æ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾ã€‚
2.  **æŠ¢å å¼ï¼ˆPreemptiveï¼‰**ï¼š
    *   **Python 2**ï¼šæ¯æ‰§è¡Œ 1000 å­—èŠ‚ç æŒ‡ä»¤å¼ºåˆ¶é‡Šæ”¾ã€‚
    *   **Python 3**ï¼šå¼•å…¥äº†è®¡æ—¶å™¨ã€‚é»˜è®¤æ¯ **15 æ¯«ç§’**ï¼ˆ`sys.getswitchinterval()`ï¼‰ï¼Œä¸»çº¿ç¨‹ä¼šå¼ºåˆ¶é‡Šæ”¾ GILï¼Œç»™å…¶ä»–çº¿ç¨‹æœºä¼šã€‚

**ç«äº‰å¸¦æ¥çš„â€œæŠ–åŠ¨â€**ï¼š
åœ¨å¤šæ ¸ CPU ä¸Šï¼Œå¦‚æœä¸å—æ§åˆ¶ï¼Œçº¿ç¨‹ A é‡Šæ”¾äº† GILï¼Œå”¤é†’çº¿ç¨‹ Bã€‚ä½†çº¿ç¨‹ A å¯èƒ½å› ä¸º CPU äº²å’Œæ€§ï¼Œç«‹åˆ»åˆæŠ¢å›äº† GILã€‚å¯¼è‡´çº¿ç¨‹ B è¢«å”¤é†’äº†å´æ²¡æ‹¿åˆ°é”ï¼Œç™½ç™½æµªè´¹ CPU èµ„æºã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Python å¤šçº¿ç¨‹åœ¨å¤šæ ¸ CPU ä¸Šè·‘ CPU å¯†é›†å‹ä»»åŠ¡æœ‰æ—¶æ¯”å•æ ¸è¿˜æ…¢ã€‚

#### ä¸€ã€å¤šçº¿ç¨‹ (Threading) â€”â€” æ”»å…‹ IO é˜»å¡

Python çš„å¤šçº¿ç¨‹ä¸»è¦ç”¨äºè§£å†³ IO é˜»å¡é—®é¢˜ï¼ˆå¦‚çˆ¬è™«ç­‰å¾…å“åº”ã€è¯»å†™ç£ç›˜ï¼‰ã€‚

##### 1. æ ¸å¿ƒæ¨¡å—ä¸å¸¸ç”¨å‡½æ•°
ä¸»è¦æ¶‰åŠ `threading` æ¨¡å—å’Œ `concurrent.futures` æ¨¡å—ã€‚

| å‡½æ•°/ç±»                              | æè¿°                                                         |
| :----------------------------------- | :----------------------------------------------------------- |
| **`threading.Thread(target, args)`** | åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ã€‚                                           |
| **`t.start()` / `t.join()`**         | å¯åŠ¨çº¿ç¨‹ / ç­‰å¾…çº¿ç¨‹ç»“æŸï¼ˆé˜»å¡ä¸»çº¿ç¨‹ï¼‰ã€‚                      |
| **`threading.Lock()`**               | äº’æ–¥é”ï¼Œç”¨äºé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸€æ•°æ®ï¼ˆç«æ€æ¡ä»¶ï¼‰ã€‚       |
| **`queue.Queue`**                    | **çº¿ç¨‹å®‰å…¨**çš„é˜Ÿåˆ—ï¼Œç”¨äºçº¿ç¨‹é—´çš„æ•°æ®ä¼ é€’ï¼ˆç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼‰ã€‚ |
| **`ThreadPoolExecutor`**             | ï¼ˆæ¨èï¼‰çº¿ç¨‹æ± ï¼Œç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼Œè·å–è¿”å›å€¼æ›´æ–¹ä¾¿ã€‚         |

##### 2. ä½¿ç”¨æ¨¡å¼è¯¦è§£

**æ¨¡å¼ Aï¼šä½¿ç”¨çº¿ç¨‹æ± ï¼ˆæ¨èï¼‰**
è¿™æ˜¯ç°ä»£ Python ç¼–å†™å¤šçº¿ç¨‹çš„æ ‡å‡†å§¿åŠ¿ï¼Œä»£ç ç®€æ´ï¼Œå®¹æ˜“è·å–è¿”å›å€¼ã€‚

```python
from concurrent.futures import ThreadPoolExecutor, as_completed
import time

def task(n):
    time.sleep(1)
    return n * n

# max_workers å»ºè®®è®¾ç½®ä¸º CPUæ ¸å¿ƒæ•° * 5 æˆ–è€…æ ¹æ® IO å¯†é›†ç¨‹åº¦è°ƒæ•´
with ThreadPoolExecutor(max_workers=5) as executor:
    # æ–¹å¼ 1: submit (é€‚åˆå¤„ç†æ¯ä¸ªä»»åŠ¡çš„ç‹¬ç«‹ç»“æœ)
    futures = [executor.submit(task, i) for i in range(5)]
    
    # è·å–ç»“æœï¼Œas_completed ä¼šåœ¨æŸä¸ªä»»åŠ¡å®Œæˆåç«‹å³è¿”å›
    for future in as_completed(futures):
        print(f"ç»“æœ: {future.result()}")

    # æ–¹å¼ 2: map (é€‚åˆæ‰¹é‡å¤„ç†ï¼Œè¿”å›é¡ºåºä¸è¾“å…¥é¡ºåºä¸€è‡´)
    # results = executor.map(task, range(5))
```

**æ¨¡å¼ Bï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼ˆä½¿ç”¨ Queueï¼‰**
é€‚ç”¨äºè§£è€¦å¤æ‚çš„æµæ°´çº¿ï¼Œä¾‹å¦‚ï¼šçº¿ç¨‹ A è´Ÿè´£çˆ¬å– URLï¼Œçº¿ç¨‹ B è´Ÿè´£è§£ææ•°æ®ã€‚

```python
import threading
import queue
import time

q = queue.Queue(maxsize=10)

def producer():
    for i in range(5):
        q.put(i)  # å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œè¿™é‡Œä¼šé˜»å¡ç­‰å¾…
        print(f"ç”Ÿäº§: {i}")
        time.sleep(0.5)

def consumer():
    while True:
        item = q.get() # å¦‚æœé˜Ÿåˆ—ç©ºäº†ï¼Œè¿™é‡Œä¼šé˜»å¡ç­‰å¾…
        if item is None: break # é€€å‡ºä¿¡å·
        print(f"æ¶ˆè´¹: {item}")
        q.task_done() # å‘ŠçŸ¥é˜Ÿåˆ—è¯¥ä»»åŠ¡å¤„ç†å®Œæ¯•

t_prod = threading.Thread(target=producer)
t_cons = threading.Thread(target=consumer)
t_prod.start()
t_cons.start()

t_prod.join()
q.put(None) # å‘é€ç»“æŸä¿¡å·
t_cons.join()
```

##### 3. æ³¨æ„äº‹é¡¹ï¼ˆå‘ç‚¹ï¼‰
1.  **GIL é™åˆ¶**ï¼š**åƒä¸‡ä¸è¦ç”¨å¤šçº¿ç¨‹åšè®¡ç®—å¯†é›†å‹ä»»åŠ¡**ï¼ˆå¦‚è§†é¢‘å¤„ç†ã€å¤§æ•°æ®è¿ç®—ï¼‰ï¼Œå¦åˆ™é€Ÿåº¦æ¯”å•çº¿ç¨‹è¿˜æ…¢ï¼ˆå› ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼‰ã€‚
2.  **çº¿ç¨‹å®‰å…¨**ï¼šå¤šä¸ªçº¿ç¨‹ä¿®æ”¹åŒä¸€ä¸ªå…¨å±€å˜é‡ï¼ˆå¦‚ `counter += 1`ï¼‰ç”±äºä¸æ˜¯åŸå­æ“ä½œï¼Œå¿…é¡»åŠ  `Lock`ï¼Œå¦åˆ™æ•°æ®ä¼šé”™ä¹±ã€‚
3.  **æ­»é” (Deadlock)**ï¼šå¦‚æœä¸€ä¸ªçº¿ç¨‹æŒæœ‰äº†é” A æƒ³è¦é” Bï¼Œå¦ä¸€ä¸ªæŒæœ‰é” B æƒ³è¦é” Aï¼Œç¨‹åºå°±ä¼šå¡æ­»ã€‚ä½¿ç”¨ `with lock:` è¯­æ³•ç³–å¯ä»¥å‡å°‘å¿˜è®°é‡Šæ”¾é”çš„é£é™©ã€‚

---

#### äºŒã€å¤šè¿›ç¨‹ (Multiprocessing) â€”â€” æ¦¨å¹²å¤šæ ¸ CPU

è¿™æ˜¯ç»•è¿‡ GILã€åˆ©ç”¨å¤šæ ¸ CPU çš„å”¯ä¸€åŸç”Ÿæ–¹å¼ã€‚

##### 1. æ ¸å¿ƒæ¨¡å—ä¸å¸¸ç”¨å‡½æ•°
ä¸»è¦ä½¿ç”¨ `multiprocessing` æ¨¡å—ã€‚

| å‡½æ•°/ç±»                       | æè¿°                                                         |
| :---------------------------- | :----------------------------------------------------------- |
| **`multiprocessing.Process`** | åˆ›å»ºè¿›ç¨‹ï¼Œç”¨æ³•ç±»ä¼¼ `threading.Thread`ã€‚                      |
| **`multiprocessing.Pool`**    | è¿›ç¨‹æ± ï¼ˆæ—§ç‰ˆæ¥å£ï¼‰ï¼Œç°åœ¨æ›´æ¨è `ProcessPoolExecutor`ã€‚       |
| **`multiprocessing.Queue`**   | **è¿›ç¨‹å®‰å…¨**çš„é˜Ÿåˆ—ï¼ˆæ³¨æ„ï¼š`queue.Queue` åªèƒ½ç”¨äºçº¿ç¨‹ï¼Œä¸èƒ½è·¨è¿›ç¨‹ï¼‰ã€‚ |
| **`multiprocessing.Manager`** | ç”¨äºåœ¨è¿›ç¨‹é—´å…±äº«å¤æ‚æ•°æ®ç»“æ„ï¼ˆå¦‚å­—å…¸ã€åˆ—è¡¨ï¼‰ã€‚               |
| **`ProcessPoolExecutor`**     | ï¼ˆæ¨èï¼‰è¿›ç¨‹æ± ï¼Œæ¥å£ä¸çº¿ç¨‹æ± ä¸€è‡´ã€‚                           |

##### 2. ä½¿ç”¨æ¨¡å¼è¯¦è§£

**æ¨¡å¼ Aï¼šè¿›ç¨‹æ± å¹¶è¡Œè®¡ç®—**

```python
import time
from concurrent.futures import ProcessPoolExecutor

def heavy_calculation(num):
    # æ¨¡æ‹Ÿ CPU å¯†é›†å‹è®¡ç®—
    result = sum(i * i for i in range(num))
    return result

# Windows/macOS ä¸‹ä½¿ç”¨å¤šè¿›ç¨‹å¿…é¡»æ”¾åœ¨ if __name__ == '__main__': ä¹‹ä¸‹
if __name__ == '__main__':
    data = [10**6, 10**6, 10**6]
    
    # è¿›ç¨‹æ•°é€šå¸¸è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° (os.cpu_count())
    with ProcessPoolExecutor() as executor:
        results = list(executor.map(heavy_calculation, data))
        
    print("è®¡ç®—å®Œæˆ:", results)
```

**æ¨¡å¼ Bï¼šè¿›ç¨‹é—´é€šä¿¡ (IPC)**

è¿›ç¨‹å†…å­˜æ˜¯éš”ç¦»çš„ï¼Œå…¨å±€å˜é‡ä¸å…±äº«ã€‚å¿…é¡»é€šè¿‡ Queue æˆ– Pipe é€šä¿¡ã€‚

```python
from multiprocessing import Process, Queue

def writer(q):
    print("è¿›ç¨‹å†™å…¥æ•°æ®...")
    q.put("Hello from Process")

def reader(q):
    msg = q.get()
    print(f"è¿›ç¨‹è¯»å–æ•°æ®: {msg}")

if __name__ == '__main__':
    # å¿…é¡»ä½¿ç”¨ multiprocessing.Queueï¼Œä¸èƒ½ç”¨ queue.Queue
    q = Queue()
    p1 = Process(target=writer, args=(q,))
    p2 = Process(target=reader, args=(q,))
    
    p1.start()
    p2.start()
    p1.join()
    p2.join()
```

##### 3. æ³¨æ„äº‹é¡¹ï¼ˆå‘ç‚¹ï¼‰

1.  **å…¥å£ä¿æŠ¤**ï¼šåœ¨ Windows å’Œ macOS (Python 3.8+) ä¸Šï¼Œå¯åŠ¨å¤šè¿›ç¨‹åº•å±‚ä½¿ç”¨ `spawn` æ–¹å¼ï¼Œ**å¿…é¡»**æŠŠå¯åŠ¨ä»£ç æ”¾åœ¨ `if __name__ == '__main__':` å—ä¸­ï¼Œå¦åˆ™ä¼šæ— é™é€’å½’æŠ¥é”™ã€‚
2.  **åºåˆ—åŒ– (Pickle)**ï¼šè¿›ç¨‹é—´ä¼ é€’çš„æ‰€æœ‰å‚æ•°å’Œè¿”å›å€¼ï¼Œéƒ½å¿…é¡»æ˜¯**å¯åºåˆ—åŒ–ï¼ˆPicklableï¼‰**çš„ã€‚Lambda å‡½æ•°ã€åŠ¨æ€ç”Ÿæˆçš„å‡½æ•°æ— æ³•åœ¨è¿›ç¨‹é—´ä¼ é€’ã€‚
3.  **å¼€é”€å¤§**ï¼šåˆ›å»ºè¿›ç¨‹æ¯”åˆ›å»ºçº¿ç¨‹æ…¢å¾ˆå¤šï¼Œä¸”å ç”¨æ›´å¤šå†…å­˜ã€‚ä¸è¦å¼€å¯æˆç™¾ä¸Šåƒä¸ªè¿›ç¨‹ï¼Œé€šå¸¸è¿›ç¨‹æ•° <= CPU æ ¸æ•°ã€‚
4.  **åƒµå°¸è¿›ç¨‹**ï¼šå¿…é¡»ç¡®ä¿å­è¿›ç¨‹è¢« `join()` å›æ”¶ï¼Œæˆ–è€…ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆ`with`ï¼‰ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´è¿›ç¨‹èµ„æºä¸é‡Šæ”¾ã€‚

---

#### ä¸‰ã€å¼‚æ­¥ IO (Asyncio) â€”â€” é«˜å¹¶å‘ä¹‹ç‹

è¿™æ˜¯åŸºäºâ€œäº‹ä»¶å¾ªç¯â€çš„å•çº¿ç¨‹å¹¶å‘ï¼Œé€‚åˆå¤„ç†æµ·é‡è¿æ¥ï¼ˆå¦‚ Web æœåŠ¡ã€WebSocketï¼‰ã€‚

##### 1. æ ¸å¿ƒå…³é”®å­—ä¸å¸¸ç”¨å‡½æ•°

| å‡½æ•°/å…³é”®å­—                     | æè¿°                                                         |
| :------------------------------ | :----------------------------------------------------------- |
| **`async def`** / **`await`**   | å®šä¹‰åç¨‹å‡½æ•° / æŒ‚èµ·å¹¶ç­‰å¾…ç»“æœã€‚                              |
| **`asyncio.run(coro)`**         | ç¨‹åºçš„å…¥å£ï¼Œå¯åŠ¨äº‹ä»¶å¾ªç¯ã€‚                                   |
| **`asyncio.create_task(coro)`** | å°†åç¨‹åŒ…è£…ä¸º Taskï¼Œåœ¨åå°å¹¶å‘è¿è¡Œï¼ˆéé˜»å¡ï¼‰ã€‚                |
| **`asyncio.gather(*tasks)`**    | ç­‰å¾…å¤šä¸ªåç¨‹åŒæ—¶ç»“æŸï¼Œå¹¶æ”¶é›†ç»“æœã€‚                           |
| **`asyncio.sleep(delay)`**      | å¼‚æ­¥ç¡çœ ï¼ˆä¸ä¼šé˜»å¡æ•´ä¸ªçº¿ç¨‹ï¼ŒåªæŒ‚èµ·å½“å‰ä»»åŠ¡ï¼‰ã€‚               |
| **`asyncio.to_thread(func)`**   | **ç¥å™¨**ï¼šåœ¨ async å‡½æ•°ä¸­è¿è¡ŒåŒæ­¥é˜»å¡ä»£ç ï¼ˆå¦‚ `time.sleep`, `requests`ï¼‰ã€‚ |

##### 2. ä½¿ç”¨æ¨¡å¼è¯¦è§£

**æ¨¡å¼ Aï¼šæ ‡å‡†å¹¶å‘æµç¨‹**

```python
import asyncio
import time

async def worker(name, delay):
    print(f"{name} å¼€å§‹")
    await asyncio.sleep(delay) # æ¨¡æ‹Ÿ IO æ“ä½œ
    print(f"{name} ç»“æŸ")
    return f"{name} ç»“æœ"

async def main():
    # æ–¹å¼ 1: gather (å¹¶å‘ç­‰å¾…æ‰€æœ‰ç»“æœ)
    print("--- Gather æ¨¡å¼ ---")
    results = await asyncio.gather(
        worker("ä»»åŠ¡A", 1),
        worker("ä»»åŠ¡B", 2)
    )
    print(results)

    # æ–¹å¼ 2: create_task (åå°è¿è¡Œï¼Œç¨åç­‰å¾…)
    print("--- Task æ¨¡å¼ ---")
    task1 = asyncio.create_task(worker("ä»»åŠ¡C", 1))
    task2 = asyncio.create_task(worker("ä»»åŠ¡D", 2))
    
    # è¿™é‡Œå¯ä»¥åšå…¶ä»–äº‹æƒ…...
    print("ä¸»ç¨‹åºç»§ç»­è¿è¡Œä¸­...")
    
    # æœ€åç­‰å¾…ä»»åŠ¡ç»“æŸ
    res1 = await task1
    res2 = await task2

if __name__ == '__main__':
    asyncio.run(main())
```

**æ¨¡å¼ Bï¼šåœ¨å¼‚æ­¥ä¸­æ··åˆåŒæ­¥ä»£ç **
è¿™æ˜¯æ–°æ‰‹æœ€å¤´ç–¼çš„åœ°æ–¹ï¼šå¦‚ä½•åœ¨ `async` å‡½æ•°é‡Œç”¨ `requests` æˆ–è¯»å–å¤§æ–‡ä»¶ï¼Ÿä½¿ç”¨ `to_thread`ã€‚

```python
import asyncio
import time

# è¿™æ˜¯ä¸€ä¸ªæ™®é€šçš„åŒæ­¥é˜»å¡å‡½æ•°
def blocking_io():
    print("å¼€å§‹é˜»å¡ IO")
    time.sleep(2) # æ³¨æ„è¿™é‡Œç”¨äº† time.sleep
    print("é˜»å¡ IO ç»“æŸ")
    return 200

async def main():
    print("ä¸»åç¨‹å¼€å§‹")
    # å°†åŒæ­¥é˜»å¡å‡½æ•°æ‰”åˆ°ç‹¬ç«‹çº¿ç¨‹ä¸­è¿è¡Œï¼Œä¸é˜»å¡äº‹ä»¶å¾ªç¯
    result = await asyncio.to_thread(blocking_io)
    print(f"å¾—åˆ°ç»“æœ: {result}")

if __name__ == '__main__':
    asyncio.run(main())
```

##### 3. æ³¨æ„äº‹é¡¹ï¼ˆå‘ç‚¹ï¼‰
1.  **ä¼ æŸ“æ€§**ï¼šä¸€æ—¦ä½¿ç”¨äº† `async`ï¼Œä¸ºäº†å‘æŒ¥æ€§èƒ½ï¼Œæ•´ä¸ªè°ƒç”¨é“¾æœ€å¥½éƒ½æ˜¯å¼‚æ­¥çš„ã€‚
2.  **ç»å¯¹ç¦æ­¢é˜»å¡**ï¼šåœ¨ `async def` å‡½æ•°ä¸­ï¼Œ**ä¸¥ç¦**ä½¿ç”¨ `time.sleep()`ã€`requests.get()` ç­‰åŒæ­¥é˜»å¡æ“ä½œã€‚è¿™ä¼šå¡æ­»æ•´ä¸ªçº¿ç¨‹ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ï¼Œå¯¼è‡´æ‰€æœ‰å¹¶å‘ä»»åŠ¡æš‚åœã€‚
    *   *è§£æ³•*ï¼šä½¿ç”¨ `aiohttp` / `httpx` ä»£æ›¿ `requests`ï¼Œä½¿ç”¨ `asyncio.sleep` ä»£æ›¿ `time.sleep`ã€‚
3.  **è°ƒè¯•å›°éš¾**ï¼šå¼‚æ­¥ä»£ç çš„æŠ¥é”™æ ˆï¼ˆTracebackï¼‰é€šå¸¸æ¯”åŒæ­¥ä»£ç éš¾çœ‹æ‡‚ï¼Œé€»è¾‘è·³è·ƒæ€§å¤§ã€‚
4.  **CPU å¯†é›†å‹ä¸é€‚ç”¨**ï¼šAsyncio æ˜¯å•çº¿ç¨‹çš„ï¼Œå¦‚æœä½ åœ¨è¿™é‡Œé¢åšå¤§é‡è®¡ç®—ï¼ˆå¦‚æ­»å¾ªç¯ï¼‰ï¼Œæ•´ä¸ªç¨‹åºä¼šå¡æ­»ã€‚è®¡ç®—ä»»åŠ¡è¯·ç»“åˆ `run_in_executor` ä½¿ç”¨å¤šè¿›ç¨‹ã€‚

æ²¡é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆè¡¥å…¨ **Celery** è¿™ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—çš„é‡ç£…é€‰æ‰‹ï¼Œç„¶åä¸“é—¨é’ˆå¯¹ä½ æåˆ°çš„ **â€œè°ƒç”¨å¤§æ¨¡å‹ APIâ€** åœºæ™¯ï¼Œç»™å‡ºä¸€å¥—æœ€ä½³å®è·µæ–¹æ¡ˆã€‚

---

#### å››ã€Celery â€”â€” åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—

å¦‚æœè¯´ `threading` å’Œ `asyncio` æ˜¯å•æœºä½œæˆ˜çš„ç‰¹ç§å…µï¼Œé‚£ä¹ˆ **Celery** å°±æ˜¯æŒ‡æŒ¥åƒå†›ä¸‡é©¬çš„å°†å†›ã€‚å®ƒä¸æ˜¯ Python çš„å†…ç½®åº“ï¼Œè€Œæ˜¯ä¸€ä¸ªå¼ºå¤§çš„ç¬¬ä¸‰æ–¹æ¡†æ¶ã€‚

##### 1. æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„
Celery å¹¶ä¸ç›´æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå®ƒæ˜¯ä¸€ä¸ª**è°ƒåº¦ç³»ç»Ÿ**ã€‚
*   **Producer (ç”Ÿäº§è€…)**ï¼šä½ çš„ä»£ç ï¼ˆWebåç«¯ã€è„šæœ¬ï¼‰ï¼Œè´Ÿè´£å‘é€ä»»åŠ¡ã€‚
*   **Broker (æ¶ˆæ¯ä¸­é—´ä»¶)**ï¼šä»»åŠ¡çš„â€œæ”¶ä»¶ç®±â€ï¼Œé€šå¸¸ä½¿ç”¨ **Redis** æˆ– **RabbitMQ**ã€‚
*   **Worker (æ¶ˆè´¹è€…)**ï¼šçœŸæ­£å¹²æ´»çš„è¿›ç¨‹ï¼Œå¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šã€‚
*   **Result Backend**ï¼šå­˜å‚¨ä»»åŠ¡ç»“æœçš„åœ°æ–¹ï¼ˆæ•°æ®åº“/Redisï¼‰ã€‚

##### 2. å¸¸ç”¨å‡½æ•°ä¸ä½¿ç”¨æ–¹æ³•

é¦–å…ˆéœ€è¦å®‰è£…ï¼š
```bash
pip install celery redis
```

**æ­¥éª¤ Aï¼šå®šä¹‰ä»»åŠ¡ (tasks.py)**

```python
from celery import Celery
import time

# é…ç½® Celeryï¼Œä½¿ç”¨ Redis ä½œä¸º Broker å’Œ Backend
app = Celery('my_tasks', 
             broker='redis://localhost:6379/0', 
             backend='redis://localhost:6379/1')

# å¸¸ç”¨é…ç½®ï¼šä»»åŠ¡è¶…æ—¶ã€é‡è¯•ç­–ç•¥ç­‰
app.conf.update(
    result_expires=3600, # ç»“æœä¿å­˜1å°æ—¶
)

@app.task(bind=True, max_retries=3) # bind=True è®©æˆ‘ä»¬èƒ½åœ¨å‡½æ•°å†…è·å– self (ä»»åŠ¡å®ä¾‹)
def send_email(self, email_address):
    try:
        print(f"æ­£åœ¨ç»™ {email_address} å‘é€é‚®ä»¶...")
        time.sleep(5) # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        # æ¨¡æ‹Ÿéšæœºå¤±è´¥
        # if random.random() < 0.1: raise Exception("ç½‘ç»œæ³¢åŠ¨")
        return f"é‚®ä»¶å·²å‘é€ç»™ {email_address}"
    except Exception as exc:
        # è‡ªåŠ¨é‡è¯•ï¼Œå€’è®¡æ—¶ 60 ç§’åé‡è¯•
        raise self.retry(exc=exc, countdown=60)
```

**æ­¥éª¤ Bï¼šå¯åŠ¨ Worker (å‘½ä»¤è¡Œ)**
ä½ å¿…é¡»åœ¨ç»ˆç«¯å¯åŠ¨ Worker è¿›ç¨‹æ¥ç›‘å¬ä»»åŠ¡ï¼š
```bash
celery -A tasks worker --loglevel=info
```
*(æ³¨ï¼šWindows ä¸‹å¦‚æœæŠ¥é”™ï¼Œéœ€è¦å®‰è£… `eventlet` å¹¶åŠ å‚æ•° `-P eventlet`)*

**æ­¥éª¤ Cï¼šè°ƒç”¨ä»»åŠ¡ (main.py)**

```python
from tasks import send_email

# .delay() æ˜¯æœ€å¸¸ç”¨çš„è°ƒç”¨æ–¹å¼ï¼Œå®ƒæ˜¯å¼‚æ­¥çš„ï¼Œç«‹å³è¿”å›ä¸€ä¸ª AsyncResult å¯¹è±¡
result = send_email.delay("test@example.com")

print(f"ä»»åŠ¡ID: {result.id}")

# è¿™ä¸€æ­¥ä¼šé˜»å¡ï¼Œç›´åˆ°æ‹¿åˆ°ç»“æœï¼ˆé€šå¸¸æˆ‘ä»¬ä¸è¿™ä¹ˆç”¨ï¼Œè€Œæ˜¯è½®è¯¢æˆ–å¿½ç•¥ç»“æœï¼‰
# print(result.get(timeout=10)) 
```

##### 3. é€‚ç”¨åœºæ™¯ä¸æ³¨æ„äº‹é¡¹
*   **åœºæ™¯**ï¼šç”¨æˆ·æ³¨å†Œå‘é€é‚®ä»¶ã€è§†é¢‘ä¸Šä¼ åçš„è½¬ç ã€æ¯å¤©å‡Œæ™¨çš„æ•°æ®æŠ¥è¡¨ã€è·¨æœºå™¨çš„ä»»åŠ¡åˆ†å‘ã€‚
*   **æ³¨æ„äº‹é¡¹**ï¼š
    1.  **å¿…é¡»è¦ Broker**ï¼šCelery è·‘ä¸èµ·æ¥é€šå¸¸æ˜¯å› ä¸ºæ²¡è£… Redis æˆ–è€… RabbitMQã€‚
    2.  **ä»£ç åŒæ­¥**ï¼šWorker æ‰€åœ¨çš„ä»£ç æ–‡ä»¶å¿…é¡»å’Œå‘é€è€…çš„ä¸€è‡´ï¼Œå¦åˆ™ Worker ä¼šæŠ¥ "Unknown Task"ã€‚
    3.  **åºåˆ—åŒ–**ï¼šå‚æ•°å¿…é¡»èƒ½è¢«åºåˆ—åŒ–ï¼ˆJSON/Pickleï¼‰ï¼Œä¸è¦ä¼ å¤æ‚çš„å¯¹è±¡ï¼ˆå¦‚æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼‰ã€‚



